import{PropertyFilter}from"./features/PropertyFilter.js";import{getModalInstance}from"./components/Modal.js";import{initAccordions}from"./components/Accordion.js";import{FormValidator}from"./features/FormValidator.js";import{initErrorHandler}from"./utils/errorHandler.js";import{createPropertiesErrorBoundary}from"./utils/errorBoundary.js";import{LazyLoader}from"./utils/lazyLoad.js";import{initComparisonSliders}from"./comparison-slider.js";import{auth}from"./auth.js";import"./theme-toggle.js";createPropertiesErrorBoundary();function registerServiceWorker(){if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(registration=>{registration.addEventListener("updatefound",()=>{const newWorker=registration.installing;newWorker.addEventListener("statechange",()=>{if(newWorker.state==="installed"&&navigator.serviceWorker.controller){}})});initCacheManagement(registration)}).catch(()=>{if(window.lazyLoader){window.lazyLoader.enableFallbackMode()}})});navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()})}else{if(window.lazyLoader){window.lazyLoader.enableFallbackMode()}}}function initCacheManagement(registration){window.p4cCache={clear:()=>new Promise((resolve,reject)=>{if(registration.active){registration.active.postMessage({type:"CLEAR_CACHE"});resolve("Cache cleared successfully")}else{reject("No active service worker")}}),getStatus:()=>new Promise((resolve,reject)=>{if(registration.active){const messageChannel=new MessageChannel;messageChannel.port1.onmessage=event=>{if(event.data.type==="CACHE_STATUS"){resolve(event.data.data)}};registration.active.postMessage({type:"GET_CACHE_STATUS"},[messageChannel.port2])}else{reject("No active service worker")}}),cacheUrls:urls=>new Promise((resolve,reject)=>{if(registration.active){registration.active.postMessage({type:"CACHE_URLS",urls:urls});resolve("URLs queued for caching")}else{reject("No active service worker")}})}}const errorHandler=initErrorHandler();const mainErrorHandler=errorHandler.createBoundary(()=>{initErrorHandler();registerServiceWorker()},{fallback:()=>{registerServiceWorker()},rethrow:false});mainErrorHandler();let propertiesData=[];const propertiesDataElement=document.getElementById("properties-data");if(propertiesDataElement){try{const data=JSON.parse(propertiesDataElement.textContent);propertiesData=data.map(prop=>({id:prop.id,name:prop.title,bedrooms:prop.bedrooms,bathrooms:prop.bathrooms,price:prop.price?prop.price.formatted:"N/A",price_amount:prop.price?prop.price.amount:0,type:prop.type,tags:prop.tags,location:prop.location,image:prop.images&&prop.images.length>0?prop.images[0]:"images/properties/properties-default.webp"}))}catch(error){propertiesData=[]}}const propertiesGrid=document.getElementById("properties-grid");if(propertiesGrid){propertiesData.forEach(prop=>{const card=document.createElement("div");card.className="property-card";const imageDiv=document.createElement("div");imageDiv.className="property-image";const sanitizedImagePath=sanitizeInput(prop.image);const allowedImagePath=path=>{if(typeof path!=="string")return false;const re=/^\/?images\/(properties|banners|icons|our-work-gallery)\/[a-z0-9/_\-.]+\.webp$/i;return re.test(path)};const imgSrc=allowedImagePath(sanitizedImagePath)?sanitizedImagePath:"images/properties/properties-default.webp";const imgEl=document.createElement("img");imgEl.src=imgSrc;const sanitizedAltText=sanitizeInput(prop.name);imgEl.alt=sanitizedAltText||"Property image";imgEl.loading="lazy";imgEl.decoding="async";imgEl.className="property-img";imageDiv.appendChild(imgEl);const contentDiv=document.createElement("div");contentDiv.className="property-content";const titleEl=document.createElement("h3");titleEl.className="property-title";const sanitizedTitle=sanitizeInput(prop.name);titleEl.textContent=sanitizedTitle||"Property";const locationEl=document.createElement("p");locationEl.style.color="var(--dark-gray)";locationEl.style.fontSize="0.9rem";locationEl.style.marginBottom="1rem";const sanitizedLocation=sanitizeInput(prop.location);locationEl.textContent=sanitizedLocation||"Location not available";const detailsDiv=document.createElement("div");detailsDiv.className="property-details";const bedsItem=document.createElement("div");bedsItem.className="detail-item";const bedsLabel=document.createElement("div");bedsLabel.className="detail-label";bedsLabel.textContent="Beds";const bedsValue=document.createElement("div");bedsValue.className="detail-value";bedsValue.textContent=prop.bedrooms.toString();bedsItem.appendChild(bedsLabel);bedsItem.appendChild(bedsValue);const bathsItem=document.createElement("div");bathsItem.className="detail-item";const bathsLabel=document.createElement("div");bathsLabel.className="detail-label";bathsLabel.textContent="Baths";const bathsValue=document.createElement("div");bathsValue.className="detail-value";bathsValue.textContent=prop.bathrooms.toString();bathsItem.appendChild(bathsLabel);bathsItem.appendChild(bathsValue);const statusItem=document.createElement("div");statusItem.className="detail-item";const statusLabel=document.createElement("div");statusLabel.className="detail-label";statusLabel.textContent="Status";const statusValue=document.createElement("div");statusValue.className="detail-value";statusValue.style.fontSize="0.8rem";statusValue.style.color="var(--gold)";statusValue.textContent=prop.price;statusItem.appendChild(statusLabel);statusItem.appendChild(statusValue);detailsDiv.appendChild(bedsItem);detailsDiv.appendChild(bathsItem);detailsDiv.appendChild(statusItem);const tagsDiv=document.createElement("div");tagsDiv.className="property-tags";if(prop.tags&&Array.isArray(prop.tags)){prop.tags.forEach(tag=>{const sanitizedTag=sanitizeInput(tag);if(sanitizedTag){const tagSpan=document.createElement("span");tagSpan.className="tag";tagSpan.textContent=sanitizedTag;tagsDiv.appendChild(tagSpan)}})}const applyLink=document.createElement("a");applyLink.href="apply.html";applyLink.className="btn btn-primary property-btn";applyLink.textContent="Apply for This Home";contentDiv.appendChild(titleEl);contentDiv.appendChild(locationEl);contentDiv.appendChild(detailsDiv);contentDiv.appendChild(tagsDiv);contentDiv.appendChild(applyLink);card.appendChild(imageDiv);card.appendChild(contentDiv);propertiesGrid.appendChild(card)})}function sanitizeInput(input){if(typeof input!=="string"){return""}if(window.DOMPurify&&typeof window.DOMPurify.sanitize==="function"){try{return window.DOMPurify.sanitize(input,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}catch(e){}}return input.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<[^>]*>/g,"").trim()}const form=document.getElementById("application-form");if(form){const successMessage=document.getElementById("success-message");form.addEventListener("submit",e=>{e.preventDefault();let isValid=true;const formGroups=form.querySelectorAll(".form-group");formGroups.forEach(group=>{const input=group.querySelector("input,select,textarea");if(!input)return;group.classList.remove("error");input.removeAttribute("aria-invalid");const sanitizedValue=sanitizeInput(input.value);if(input.required&&(!sanitizedValue||sanitizedValue.trim()==="")){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.type==="email"&&sanitizedValue&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(sanitizedValue)){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.id==="phone"&&sanitizedValue&&!/^[0-9\-+()\s.,]+$/.test(sanitizedValue)){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.type==="checkbox"&&!input.checked){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.type==="text"&&input.name==="name"&&sanitizedValue&&sanitizedValue.length<2){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}});if(isValid){successMessage.classList.add("show");form.style.display="none";setTimeout(()=>{form.reset();form.style.display="block";successMessage.classList.remove("show")},3e3)}})}async function fetchCSRFToken(){try{const response=await fetch("/api/csrf",{method:"GET",credentials:"include"});if(response.ok){const data=await response.json();return data.csrfToken}return"fallback-csrf-token"}catch{return"fallback-csrf-token"}}async function addCSRFTokenToForm(form){const csrfToken=await fetchCSRFToken();const csrfInput=form.querySelector('input[name="csrfToken"]');if(csrfInput){csrfInput.value=csrfToken}}const contactForm=document.getElementById("contact-form");if(contactForm){const contactSuccess=document.getElementById("contact-success");addCSRFTokenToForm(contactForm);contactForm.addEventListener("submit",async e=>{e.preventDefault();let isValid=true;const contactFormGroups=contactForm.querySelectorAll(".form-group");contactFormGroups.forEach(group=>{const input=group.querySelector("input,textarea");if(!input)return;group.classList.remove("error");input.removeAttribute("aria-invalid");const sanitizedValue=sanitizeInput(input.value);if(input.required&&(!sanitizedValue||sanitizedValue.trim()==="")){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.type==="email"&&sanitizedValue&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(sanitizedValue)){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}else if(input.type==="text"&&input.name==="name"&&sanitizedValue&&sanitizedValue.length<2){group.classList.add("error");input.setAttribute("aria-invalid","true");isValid=false}});if(isValid){const formData=new FormData(contactForm);const csrfToken=formData.get("csrfToken");try{const response=await fetch("/api/contact",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":csrfToken},body:JSON.stringify({name:formData.get("contactName"),email:formData.get("contactEmail"),phone:formData.get("contactPhone"),subject:formData.get("contactSubject"),message:formData.get("contactMessage")})});if(response.ok){contactSuccess.style.display="block";contactForm.style.display="none";setTimeout(()=>{contactForm.reset();contactForm.style.display="block";contactSuccess.style.display="none";addCSRFTokenToForm(contactForm)},3e3)}else{const errorData=await response.json();alert("Error submitting form:"+(errorData.message||"Please try again"))}}catch(error){alert("Network error. Please check your connection and try again.")}}})}const skipLink=document.querySelector(".skip-link");if(!skipLink){const newSkipLink=document.createElement("a");newSkipLink.href="#main-content";newSkipLink.textContent="Skip to main content";newSkipLink.className="skip-link";document.body.prepend(newSkipLink)}document.addEventListener("click",e=>{if(e.target.classList.contains("js-scroll-to")){e.preventDefault();const targetId=e.target.getAttribute("data-target");const targetElement=document.getElementById(targetId);if(targetElement){targetElement.scrollIntoView({behavior:"smooth",block:"start"})}}});document.querySelectorAll("img").forEach(img=>{if(!img.alt){}});document.addEventListener("DOMContentLoaded",async()=>{auth.init();try{const lazyLoader=new LazyLoader;window.lazyLoader=lazyLoader}catch(e){}try{const modal=getModalInstance();window.modal=modal}catch(e){}try{const accordions=initAccordions(".accordion");window.accordions=accordions}catch(e){}try{initComparisonSliders()}catch(e){}const propertiesContainer=document.getElementById("properties-grid");if(propertiesContainer&&propertiesData.length>0){try{const formattedProperties=propertiesData.map((prop,index)=>({id:`property-${index}`,slug:prop.name.toLowerCase().replace(/\s+/g,"-"),name:prop.name,address:prop.location,city:prop.location.split(",")[0].trim(),bedrooms:prop.bedrooms,bathrooms:prop.bathrooms,sqft:prop.sqft,image:prop.image,tags:prop.tags.map(tag=>{if(tag.includes("Section 8"))return"Section 8";if(tag.includes("HUD-VASH"))return"HUD-VASH";if(tag.includes("Pet")||tag.includes("Family"))return"Pet Friendly";return tag}),featured:index===0}));const propertyFilter=new PropertyFilter(formattedProperties,"#properties-grid");propertyFilter.init();window.propertyFilter=propertyFilter}catch(e){}}const applicationForm=document.getElementById("application-form");if(applicationForm){try{const appValidator=new FormValidator("#application-form",{onSubmit:async data=>{const successMessage=document.getElementById("success-message");if(successMessage){successMessage.classList.add("show");applicationForm.style.display="none"}setTimeout(()=>{applicationForm.reset();applicationForm.style.display="block";if(successMessage){successMessage.classList.remove("show")}},3e3)},onError:errors=>{}});window.applicationFormValidator=appValidator}catch(e){}}const contactFormEl=document.getElementById("contact-form");if(contactFormEl){try{const contactValidator=new FormValidator("#contact-form",{onSubmit:async data=>{const contactSuccess=document.getElementById("contact-success");if(contactSuccess){contactSuccess.style.display="block";contactFormEl.style.display="none"}setTimeout(()=>{contactFormEl.reset();contactFormEl.style.display="block";if(contactSuccess){contactSuccess.style.display="none"}},3e3)}});window.contactFormValidator=contactValidator}catch(e){}}document.body.addEventListener("keydown",e=>{if(e.key==="Tab"){document.body.classList.add("keyboard-nav")}});document.body.addEventListener("mousedown",()=>{document.body.classList.remove("keyboard-nav")});initResponsiveHeroBackgrounds()});function initResponsiveHeroBackgrounds(){if(typeof window.LazyLoader!=="undefined"||typeof LazyLoader!=="undefined"){const heroSection=document.querySelector(".hero");if(heroSection){const heroImageBase="/images/banners/hero-home-banner";const responsiveBg=` linear-gradient( 135deg,rgba(11,17,32,0.8) 0%,rgba(11,17,32,0.6) 100%),url('${heroImageBase}-800w.webp') `;heroSection.style.backgroundImage=responsiveBg;const style=document.createElement("style");style.textContent=` @media (max-width:600px){.hero{background-image:linear-gradient( 135deg,rgba(11,17,32,0.8) 0%,rgba(11,17,32,0.6) 100%),url('${heroImageBase}-400w.webp')}}@media (min-width:601px) and (max-width:1000px){.hero{background-image:linear-gradient( 135deg,rgba(11,17,32,0.8) 0%,rgba(11,17,32,0.6) 100%),url('${heroImageBase}-800w.webp')}}@media (min-width:1001px){.hero{background-image:linear-gradient( 135deg,rgba(11,17,32,0.8) 0%,rgba(11,17,32,0.6) 100%),url('${heroImageBase}-1200w.webp')}}`;document.head.appendChild(style)}}}